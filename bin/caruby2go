#!/usr/bin/env ruby

require 'thor'
require_relative '../lib/caruby2go.rb'
require 'pry'

##
# Script for running the gem from the command line
class Caruby2goScript < Thor
  RECORD_SEPARATOR = '========================================================='
  desc 'vehicles CITY', 'get vehicles for CITY'
  def vehicles(city)
    call_api(city)
  end

  desc 'locations', 'get Car2Go cities'
  def locations
    call_api
  end

  desc 'gasstations', 'get gas stations for CITY'
  def gasstations(city)
    call_api(city)
  end

  desc 'parkingspots', 'get parking spots for CITY'
  def parkingspots(city)
    call_api(city)
  end

  private

  # this is set using an environment variable
  def require_key
    return if ENV['CONSUMER_KEY']
    puts 'Set environment variable CONSUMER_KEY to your Car2Go consumer key.'
    puts 'For example:'
    puts '    $ CONSUMER_KEY=mykey bin/caruby2go v twincities'
    false
  end

  def call_api(city = nil)
    require_key
    caruby2go = Caruby2go.new(ENV['CONSUMER_KEY'], city)
    results = caruby2go.send("#{caller_locations(1, 1)[0].label}".to_sym)
    pretty_print results
  end

  def pretty_print(records)
    records.each do |record|
      puts RECORD_SEPARATOR
      record.each do |k, v|
        puts "#{k}:: #{v}"
      end
    end
    puts RECORD_SEPARATOR
  end
end

Caruby2goScript.start(ARGV)
