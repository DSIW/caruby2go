require 'thor'
require_relative '../lib/caruby2go.rb'
require 'pry'

class Caruby2goScript < Thor
  RECORD_SEPARATOR = '=============================================================='
  desc 'vehicles CITY', 'get vehicles for CITY'
  def vehicles(city)
    call_api(city)
  end

  desc 'locations', 'get Car2Go cities'
  def locations
    call_api
  end

  desc 'gasstations', 'get gas stations for CITY'
  def gasstations(city)
    call_api(city)
  end

  desc 'parkingspots', 'get parking spots for CITY'
  def parkingspots(city)
    call_api(city)
  end

  private 
  # this is set using an environment variable
  def require_key
    unless ENV['CONSUMER_KEY']
      puts 'Set environment variable CONSUMER_KEY to your Car2Go consumer key.  For example,'
      puts '    $ CONSUMER_KEY=mykey ruby bin/caruby2go v twincities'
      exit
    end
  end

  def call_api(city=nil)
    require_key
    pretty_print (Caruby2go.new(ENV['CONSUMER_KEY'], city).send("get_#{caller_locations(1,1)[0].label}".to_sym))
  end

  def pretty_print(records)
    records.each { |record| 
      puts RECORD_SEPARATOR
      record.each {|k, v|
        puts "#{k}:: #{v}"
      }
    }
    puts RECORD_SEPARATOR
  end
end

Caruby2goScript.start(ARGV)